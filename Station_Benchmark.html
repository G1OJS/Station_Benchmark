
<!DOCTYPE html>
<html lang="en">
<head>
<title>Benchmark My Station V1.0.0</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
	:root {background-color: #91FCFE; 
			--main-paper-color:#cce5ff; 
			--light-paper-color:#eff7ff;	 
			text-align: left; color:#4e4e4e;}
	div {background-color:var(--main-paper-color); margin: 0px;  padding: 5px;}
	#app {margin:0px; padding:5px; background-color:blue; width:fit-content;} 
	#appTitle {text-align: center; font-size: 3rem;}
	#appTop { display: grid; background-color:var(--main-paper-color); grid-template-columns: max-content auto; grid-template-rows: auto;}
	#clock {display:inline-block;  padding:5px; background-color:lightblue; font-size:2rem;}
	#innerScreen { display: grid; grid-template-columns:  auto; grid-template-rows: auto; }

	.innerPanel {border: solid grey 2px; }
	.innerPanel .title {font-size:1.7rem; font-weight:bold;}

	fieldset {padding-left:5px; font-size:1rem; width:fit-content; float:left;}
	fieldset > div {float:left; padding-left:0px;}
	fieldset > div >* {vertical-align:middle;}
	.settings-row {display: grid; grid-template-columns: 1fr 2fr;align-items: center; gap: 0.5rem;}
	.settings-label {font-weight: 600;color: #333;}
	.settings-input {width: 100%;}
    .settings-input:invalid {border-color: #e66;background-color: #fee;}
	output {background-color:var(--light-paper-color);}
	.button {font-size:0.7rem; color:#404040; padding: 0.2em 0.3em; border-radius: 0.5em; background-color: silver; border: 4px solid grey; cursor: pointer;}
	.button.active {border: 2px solid black; color:blue; font-weight:bold;}
	.button-tiny {font-size:0.6rem; padding: 0.1em 0.1em; border-radius: 0.2em; background-color: silver; border: 1px solid grey; cursor: pointer;  vertical-align:middle;}
	.button-tiny.active {border: 2px solid black;}

	.anyGrid {padding:1px; display: grid; grid-template-rows: auto; }
	.anyGrid > div {background-color:var(--light-paper-color); margin: 1px;  padding-left: 5px; padding-right: 5px; font-size: 1rem; min-height:10px; }

	.anyGrid > .TopRow.Tx  {background-color:#ffb3b3; font-weight:bold;}
	.anyGrid > .TopRow.Rx  {background-color: #99e699; font-weight:bold;}
	.anyGrid > .TopRow  {background-color:lightgrey; font-weight:bold;}
	.anyGrid > .active  {background-color:yellow;}
	.anyGrid > .pad  {background-color:var(--main-paper-color)}
	.anyGrid > .zero {color: #ccc; font-style: italic;}

	a:link {color: blue;}
	a:visited {color: blue;}
	.smallText{font-size: 0.4rem;}

	#creditsGrid { font-size: 0.8em; display: grid; grid-template-columns: auto auto auto; grid-template-rows: auto;}
	#creditsGrid > * {background-color: #91FCFE;}
 
</style>
</head>
<body>
<div id="app">
    <div id='appTitle'>Benchmark My Station</div>
    <div id="appTop">
      <div>
      <output id='clock'></output><br><span class='notesText'>Running for <output id='runningMins'></output> minutes</span>
      <br><span class='notesText'><output id='connectionsIn'></output> connections in database </span>
     </div>
     <div>               
        <fieldset>
		  <legend>Settings</legend>
		   <label class='settings-row'>
		      <span class="settings-label">My Callsign</span>
			  <input class = 'settings-input' id='myCallInput' type="text" onchange='updateMyCall();'
			         title='Your callsign'>
		   </label>
		   <label class='settings-row'>
		      <span class="settings-label">Grid Square(s)</span>
		      <input class = 'settings-input' id='homeSquaresInput' type="text" onchange='updateSquaresList();' 
			         title='The grid squares containing the other stations you want to benchmark against'>
		   </label>
		   <label class='settings-row'>
		      <span class="settings-label">Purge minutes</span>
		      <input class = 'settings-input' id='purgeMinutes' type="number" min="1" max="60" onchange='updatePurgeMins()'
			         title='Number of minutes after which spots are deleted from database'>
		   </label>
        </fieldset>
        <fieldset id=modeSelect >
         <legend>Mode</legend>
         <!-- written by script -->
        </fieldset>
     </div>
   </div>
   <div id="innerScreen">
     <div class="innerPanel" id="bandsContainer">
   </div>

   <div id="creditsGrid">
        <div>
            Javascript & HTML developed by Alan Robinson:<br>
            <a href='https://www.qrz.com/db/G1OJS'>G1OJS @QRZ.com</a><br>
            <a href='https://www.instagram.com/g1ojs_alan/'>G1OJS_alan@instagram.com</a><br>
            <a href='https://g1ojs.github.io/'>G1OJS Ham Radio @GitHub</a><br>
           <a href="mailto:G1OJS@yahoo.com">G1OJS@yahoo.com</a>
       </div>
       <div>
            Thanks to:<br>
            Philip Gladstone - N1DQ for <a href='https://pskreporter.info/'>Pskreporter.info</a><br>
            Tom Fanning - M0LTE for <a href='http://mqtt.pskreporter.info/'>mqtt.pskreporter.info</a>, the MQTT feed for this app<br>
            <a href='https://www.unpkg.com/browse/mqtt@5.10.1/README.md'>www.unpkg.com</a> for the cdn MQTT library used here <a href='https://www.unpkg.com/browse/mqtt@5.10.1/LICENSE.md'>MIT license</a>
       </div>
       <div>
          License: <a href='https://github.com/G1OJS/BandOpticon/blob/main/LICENSE'>MIT license</a><br>
          GitHub: <a href='https://github.com/G1OJS/Station_Benchmark/'>github.com/G1OJS/Station_Benchmark</a><br>
	</div>
    </div>
	
</div> 
       
<!--Get the library for MQTT functions -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- BandOpticon script -->
<script>

 // initialisation and functions to load and save configuration
  const defaultSquaresList="IO50:99,JO01,JO02,JO03"; // used if squaresList value can't be set from localstorage
  let squaresArr=[]; // contains the full list of every square (level 4, 6, 8, 10) that we want to watch, generated from squaresList
  var squaresList=""; // the human-firendly list of squares to watch
  var refresh_mSeconds=5000;
  var purgeMinutes=5;
  var nL4sq=0;
  var mqttClient=null;	
  var tStart=Date.now(); // software start time
  var connections = {};
  var connectionsAdded=0;
  var connectionsPurged=0;
  var watchedMode="FT8";

  loadConfig();
  refreshDisplays();
  setInterval(updateAppTop,1000);
  setInterval(refreshDisplays, refresh_mSeconds);
  setInterval(purgeSpots, 15000);
  connectToFeed();
  
 
  function updateMyCall(){
    myCall=document.getElementById('myCallInput').value;
	console.log("my Call updated to " + myCall);
	saveConfig();
	refreshDisplays();
  }
  
   function updateSquaresList(){
      squaresList=document.getElementById('homeSquaresInput').value; // potentially mixed case but that's OK
      saveConfig();
      squaresArr=parseSquares(squaresList); // returns uppercase squares, expanded if necessary
      connectToFeed();
      refreshDisplays();
  }
  
  function updatePurgeMins(){
    purgeMinutes=document.getElementById('purgeMinutesInput').value;
	console.log("Purge mins updated to " + purgeMinutes);
	saveConfig();
	purgeSpots();
	refreshDisplays();
  }  
  
  function purgeAllSpots(){
     connections = {};
     connectionsAdded=0;
     connectionsPurged=0;
     leaderboardsList.clear();
  }
  
  function refreshDisplays(){
   writeAllBandsStats();
   writeModeButtons();
  } 
  
  // connect to MQTT feed  
   function connectToFeed(){
  //pskr/filter/v2/{band}/{mode}/{sendercall}/{receivercall}/{senderlocator}/{receiverlocator}/{sendercountry}/{receivercountry}
    mqttClient=mqtt.connect("wss://mqtt.pskreporter.info:1886");
    mqttClient.onSuccess=subscribe();
    mqttClient.on("message", (filter,message) => {onMessage(message.toString());}  );
  }

  // subscribe to needed squares
  function subscribe(){
    //pskr/filter/v2/{band}/{mode}/{sendercall}/{receivercall}/
    //{senderlocator}/{receiverlocator}/{sendercountry}/{receivercountry}
    
    // find the level 4 squares we need to subscribe to in order to get messages for our squares in squaresArr
    let subs=new Set;
    for(let i=0;i<squaresArr.length;i++){subs.add(squaresArr[i].substring(0,4));}
    let subsArr=Array.from(subs);
    nL4sq=subsArr.length;
    
    // now subscribe to the level 4 squares
    subsArr.forEach((sq) => {
      var topic='pskr/filter/v2/+/+/+/+/'+sq+'/+/+/#';
      console.log("Subscribe to "+topic);
      mqttClient.subscribe(topic, (error) => {if (error) {
              console.error('subscription failed to '+topic, error)}});
      var topic='pskr/filter/v2/+/+/+/+/+/'+sq+'/+/#';
      console.log("Subscribe to "+topic);
      mqttClient.subscribe(topic, (error) => {if (error) {
              console.error('subscription failed to '+topic, error)}});
    } );
  }

  // process MQTT messages - add to "connections" data structure
  function onMessage(msg){
    // message format:
    // sq:sequence number b:band f:frequency md:mode rp:report (snr) t:seconds since 1970-01-01
    // sc/rc:sender call/receiver call sl/rl:sender locator/receiver locator sa/ra:sender ADIF/receiver ADIF
    // first, build conn object for this msg using same keys as PSKR MQTT:
    const conn={};
    msg.slice(1, -1).replaceAll('"','').split(',')
         .forEach(function(v) {
           let kvp=v.split(":");
           conn[kvp[0]]=kvp[1];
         });
	  
    // add sender and receiver domain (home/dx)
    if(squareIsInHome(conn.sl)){conn["sd"]="home"} else {conn["sd"]="dx"}
    if(squareIsInHome(conn.rl)){conn["rd"]="home"} else {conn["rd"]="dx"}

    // add distance and bearing Home to DX 
    // if both in home, sender to receiver
    // compact logic == always sender to receiver unless Rx in home and Tx in DXin which case reverse
      conn["kmDeg"]= (conn.rd=="home" && conn.sd=="dx") ? squaresToKmDeg(conn.rl,conn.sl):squaresToKmDeg(conn.sl,conn.rl);

    // now add this connection to the connections object using sequence ID as key:
    if(conn.rd=="home" || conn.sd=="home") {
      connections[conn.sq]=conn
      connectionsAdded+=1;
    }
  }
  
   function purgeSpots(){
   // get rid of spots older than purgeMinutes  
     for (id in connections) {
       let tConn=parseInt(connections[id].t);
       let connAge=((Date.now()/1000-tConn))/60
       if(connAge > purgeMinutes) {
         delete connections[id];
         connectionsPurged+=1;
       }
     }
   }

  function squareIsInHome(sqm){
    // return true if the level 4, 6, 8 or 10 square sq is in the home squares array
    let sq=sqm.toUpperCase();
    return (squaresArr.includes(sq.substring(0,4)) || squaresArr.includes(sq.substring(0,6)) || squaresArr.includes(sq.substring(0,8)) || squaresArr.includes(sq.substring(0,10)));
  }

  function parseSquares(sqsList){
    // returns uppercase squares, expanded if necessary
    var outputSqsArr=new Array();
    var inputSqs=sqsList.toUpperCase().split(','); // internally we work with uppercase squares
    console.log("Parsing squares list "+inputSqs);
    for(i=0;i<inputSqs.length;i++){
      let sq=inputSqs[i].trim();
      let cln=sq.search(":");
      if(cln<0){
        outputSqsArr.push(sq)
      } else {
        let root=sq.substring(0,cln-2);
        for(let x=sq.charCodeAt(cln-2);x<sq.charCodeAt(cln+1)+1;x++){
          for(let y=sq.charCodeAt(cln-1);y<sq.charCodeAt(cln+2)+1;y++){
            outputSqsArr.push(root+String.fromCharCode(x)+String.fromCharCode(y))
          }
        }
      }   
    }
    console.log("Parsed squares result "+outputSqsArr);
    return outputSqsArr;
  }

   function mhToLatLong(Sq_mixedCase,inRadians=false){
    let Sq=Sq_mixedCase.toUpperCase();
    let lat=10*(Sq.charCodeAt(1)-65);
    let lon=20*(Sq.charCodeAt(0)-65);
    if(Sq.length>2) {
      lat+=parseInt(Sq.charAt(3));
      lon+=2*parseInt(Sq.charAt(2));
    }
    if(Sq.length>4){
      lat+=(Sq.charCodeAt(5)-65)/24;
      lon+=(Sq.charCodeAt(4)-65)/12;
    }
    lat+=1/48.0 - 90;
    lon+=1/24.0 - 180;
    if(inRadians){
	    lat=lat*Math.PI/180;    
	    lon=lon*Math.PI/180;    
    }
    return {"lat":lat,"lon":lon}
  }

  function squaresToKmDeg(SqA,SqB){
	  
     let A=mhToLatLong(SqA,true);
     let B=mhToLatLong(SqB,true);
     let dLat=B.lat-A.lat;
     let dLon=B.lon-A.lon;
     let a=Math.pow(Math.sin(dLat/2),2)+Math.cos(A.lat)*Math.cos(B.lat)*Math.pow(Math.sin(dLon/2),2);
     let c=2.0*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
     let km=6371.0*c;
     let y=Math.sin(dLon)*Math.cos(B.lat);
     let x=Math.cos(A.lat)*Math.sin(B.lat) - Math.sin(A.lat)*Math.cos(B.lat)*Math.cos(dLon);
     let th=Math.atan2(y,x);
     let brg=(th*180/Math.PI + 360) %360;

     return({"km":Math.round(km),"deg":Math.round(brg)});
  }
	
   function get_utc_timestamp(){ 
    var t=new Date;
    return t.getUTCDate()+"/"+(t.getUTCMonth()+1)+"/"+t.getUTCFullYear()+" "
       +("0"+t.getUTCHours()).slice(-2)+":"
       +("0"+t.getUTCMinutes()).slice(-2)+":"
       +("0"+t.getUTCSeconds()).slice(-2)+" UTC";
  }
  
  function saveConfig(){
      console.log("Saving config:");
      localStorage.setItem('squaresList', JSON.stringify(squaresList));
      console.log("Saved Squares List: "+squaresList);
      localStorage.setItem('myCall', JSON.stringify(myCall));
      console.log("Saved myCall: "+myCall);
      localStorage.setItem('purgeMinutes', purgeMinutes);
      console.log("Saved purgeMinutes: "+purgeMinutes);
  }
  
  function loadConfig(){
    console.log("Loading config data");
    if(localStorage.getItem('squaresList')){
      squaresList=JSON.parse(localStorage.getItem('squaresList'));
      console.log("Loaded squares list");
    } else {
      squaresList=defaultSquaresList;
      console.log("No local config data found for squares list: defaults applied.");
      saveConfig();
    }
    let homeSquaresInput=squaresList.replaceAll(',',', '); // add spaces to give an opportunity for linebreaks
    document.getElementById("homeSquaresInput").value=homeSquaresInput; 
    squaresArr=parseSquares(squaresList); // returns uppercase squares, expanded if necessary
    
    if(localStorage.getItem('myCall')){
      myCall=JSON.parse(localStorage.getItem('myCall'));
      console.log("Loaded myCall " + myCall);
      document.getElementById("myCallInput").value=myCall;
    } else {
      console.log("No local config data found for my callsign: defaults applied.");
      myCall="G1OJS";
      saveConfig();
    }
	  
    if(localStorage.getItem('purgeMinutes')){
      purgeMinutes=localStorage.getItem('purgeMinutes');
      document.getElementById("purgeMinutes").value=purgeMinutes;
      console.log("Loaded purge mins");
    } else {
      purgeMinutes=5;
      saveConfig();
    }
  }
     
  function writeModeButtons(){
    let activeModes=new Set();
    for (id in connections) {activeModes.add(connections[id].md);}
	let el=document.getElementById("modeSelect");
	el.innerHTML="<legend>Mode</legend>";
	activeModes.forEach((md) => {
	  let modeBtn = "<button type='button' class='button' name='modeSelectBtn' id='"+md+"' onclick='setMode(&quot;"+md+"&quot;)'> "+md+" </button> "
	  el.innerHTML += modeBtn;
	  if(md == watchedMode) document.getElementById(md).classList.add('active');
	});
	writeAllBandsStats();
  }
 
  function setMode(mode){
    watchedMode = mode;
	writeModeButtons();
  }
 
  function updateAppTop(){
    var now = new Date;
    var utc_timestamp=get_utc_timestamp(now);
    var runningmins=Math.trunc(((now-tStart)/1000) / 60);
    // update the top banner  
    document.getElementById("clock").innerHTML=utc_timestamp.split(" ")[1]+"&nbsp;"+utc_timestamp.split(" ")[2];
    document.getElementById("runningMins").value=runningmins;
    document.getElementById("connectionsIn").value=connectionsAdded-connectionsPurged;
//	document.getElementById('nL2sq').value=" (" + (nL4sq/100).toFixed(2) + " TL sqs)";
  }

 function wavelength(band){
   let wl=parseInt(band.split("m")[0]);
   if (band.search("cm")>0) {return wl/100} else {return wl}
 }
	
	
 function safePercentage(numerator, denominator) {
  if (denominator == 0) return "0%";
  return Math.round((numerator / denominator) * 100)+"%";
 }
 

function writeAllBandsStats(){
   let activeBands = new Set();
   for (id in connections) {
     if(connections[id].md == watchedMode) activeBands.add(connections[id].b);
   }
   let activeBandsArr = Array.from(activeBands).sort((a,b) =>  wavelength(b)-wavelength(a));
   
   let g=document.getElementById("bandsContainer");
   g.innerHTML="";
   
   g.innerHTML += "<h3>Transmitting</h3>";   
   writeStatsRowLabels("Tx","Transmitters");
   activeBandsArr.forEach((band) => writeThisBandStats(band, "Tx"));
   
   g.innerHTML +="<div style='clear:both'>";
   g.innerHTML += "<h3>Receiving</h3>";   
   writeStatsRowLabels("Rx","Receivers");
   activeBandsArr.forEach((band) => writeThisBandStats(band, "Rx"));

   document.querySelectorAll("div").forEach(div => {
     if (div.innerText.trim() === "0" | div.innerText.trim() === "0%") {div.classList.add("zero");}
   });
}

function writeStatsRowLabels(){
    let g=document.getElementById("bandsContainer");
    g.innerHTML +="<div style='float:left'>"
	 + "<div class = 'anyGrid' style='grid-template-columns:max-content; grid-template-rows: auto auto auto auto;'>"
     + "<div class = 'TopRow' title = 'Band (number of callsigns active in home squares on this band)'>Band (n. calls)</div>"
     + "<div title = 'Number of spots generated by all callsigns in home, as a group'>Total spots</div>"
     + "<div title = 'Number of spots generated by best performing callsign in home'>Leader</div>"
     + "<div title = 'Number of spots generated by my callsign'>" + myCall + "</div>"
     + "</div></div>";
}

 function writeThisBandStats(bandName, RxTx){
   let g=document.getElementById("bandsContainer");
   let activeHomeCalls = new Set ();
   for (id in connections) {
     let c=connections[id];
     if(c.b == bandName && c.md == watchedMode){
       if ((c.sd=="home") && (RxTx=="Tx")) activeHomeCalls.add(c.sc); 
       if ((c.rd=="home") && (RxTx=="Rx")) activeHomeCalls.add(c.rc); 
	 }
   }  
   
   let nMe = 0;
   let nMax = 0;
   let winner = "";
   let otherEndCallsAggregate = new Set ();
   activeHomeCalls.forEach((call) => 
   {
	 let otherEndCalls=new Set();
	 for (id in connections) {
	  let c=connections[id];
	  if(c.b == bandName && c.md == watchedMode){
        if ((c.sc == call) && (RxTx=="Tx")) {otherEndCallsAggregate.add(c.rc); otherEndCalls.add(c.rc);}
        if ((c.rc == call) && (RxTx=="Rx")) {otherEndCallsAggregate.add(c.sc); otherEndCalls.add(c.sc);}
	  }
	 }
	 let nOtherEnd = otherEndCalls.size;
	 if (nOtherEnd > nMax) {
       winner = call;	  
 	   nMax = nOtherEnd;
	 }
	 
	 if (call == myCall) nMe = nOtherEnd;
   });
   
   let nActive = activeHomeCalls.size;
   let nOtherAggregate = otherEndCallsAggregate.size;
   
    g.innerHTML+="<div style='float:left; padding-left:1px; padding-right:1px;'>"
	 + "<div class='anyGrid' style='grid-template-columns:max-content; grid-template-rows: auto auto auto auto; '>"
     + "<div class='TopRow' >" + bandName + " (" + nActive.toString() + ")</div>"
     + "<div>" + nOtherAggregate.toString() + "</div>"
     + "<div title = '" + winner + "'>" + nMax.toString() +  "</div>"
     + "<div title = '" + myCall + "'>" + nMe.toString() + "</div>"
     + "</div></div>";

}

</script>

</body>
</html>
